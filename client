#! /usr/bin/env node
const fs = require('fs')
const path = require('path')
const UserHTTP = require('./http/user.js')

const args = require('minimist')(process.argv.slice(2), {
  string: [
    'host',
    'attributes',
    'application'
  ],
  boolean: [
    'help'
  ],
  alias: {
    h: 'help',
    H: 'host',
    a: 'application'
  },
  default: {}
})

if (args.help) {
  console.error(`client - interact with issuer and verifier servers

usage: client -h
usage: client get-certifications <issuer-hostname>
usage: client register application <certificateId>
usage: client show attributes <certificateId>
usage: client revoke <certificateId>

Options:
    -h, --help      Show help message
`)
  process.exit(0)
}

const command = args._[0]

switch (command) {
  case 'get-certifications': getCertifications(); break
  case 'register': register(); break
  case 'show': show(); break
  case 'revoke': revoke(); break
  default:
    console.error('Unknown command', command)
    process.exit(1)
}

function getCertifications () {
  const issuerHostname = args._[1]
  if (issuerHostname == null) {
    console.error('<issuer-hostname> must be provided')
    process.exit(1)
  }

  const user = new UserHTTP(issuerHostname, 'http://localhost:9999')

  user.getCertifications((err) => {
    if (err) throw err

    fs.writeFile('userEncoded', user.encode(), (err) => {
      if (err) throw err
    })
  })
}

function register () {
  fs.readFile('userEncoded', (err, contents) => {
    if (err) return console.log(err)

    const user = UserHTTP.decode('http://localhost:8080', 'http://localhost:9999', contents)

    const certId = args._[1]
    if (certId == null) {
      console.error('<certificateId> must be provided')
      process.exit(1)
    }

    if (!isCertId(certId)) {
      console.error('wrong certId')
      process.exit(1)
    }

    if (args.application === '') {
      console.error('--application must be provided')
      process.exit(1)
    }

    var applicationPath = path.resolve(args.application)

    const details = JSON.parse(fs.readFileSync(applicationPath, 'utf8'))

    user.createApplication(details, certId, (err, issuanceInit) => {
      if (err) throw err

      user.obtain(Buffer.from(issuanceInit), (err, final) => {
        if (err) throw err

        user.store(Buffer.from(final))
        console.log('5) User has stored the completed credential. The completed credential can be presented to a verifier.')

        fs.writeFile('userEncoded', user.encode(), (err) => {
          if (err) throw err
        })
      })
    })
  })
}

function show () {
  const certId = args._[1]
  if (certId == null) {
    console.error('<certificateId> must be provided')
    process.exit(1)
  }

  if (!isCertId(certId)) {
    console.error('wrong certId')
    process.exit(1)
  }

  if (!args.attributes) {
    console.log('--attributes must be provided')
    process.exit(1)
  }

  const attributes = args.attributes.toString().split(',')

  fs.readFile('userEncoded', (err, contents) => {
    if (err) return console.log(err)

    const user = UserHTTP.decode('http://localhost:8080', 'http://localhost:9999', contents)

    user.present(attributes, certId, (err) => {
      if (err) throw err

      fs.writeFile('userEncoded', user.encode(), (err) => {
        if (err) throw err
      })
    })
  })
}

function revoke () {
  const certId = args._[1]

  console.log(certId)
  if (certId == null) {
    console.error('<certificateId> must be provided')
    process.exit(1)
  }

  if (!isCertId(certId)) {
    console.error('wrong certId')
    process.exit(1)
  }

  fs.readFile('userEncoded', (err, contents) => {
    if (err) return console.log(err)

    const user = UserHTTP.decode('http://localhost:8080', 'http://localhost:9999', contents)

    user.revoke(certId, (err) => {
      if (err) throw err
    })
  })
}

function isCertId (certId) {
  if (certId.length !== 64) return false
  if (/[a-fA-F0-9]{64}/.test(certId) === false) return false

  return true
}
